<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- Training Location list view -->
    <record id="view_training_location_tree" model="ir.ui.view">
        <field name="name">glucose.training.location.tree</field>
        <field name="model">glucose.training.location</field>
        <field name="arch" type="xml">
            <list string="Training Locations">
                <field name="name"/>
                <field name="active"/>
            </list>
        </field>
    </record>

    <!-- Training Location form view -->
    <record id="view_training_location_form" model="ir.ui.view">
        <field name="name">glucose.training.location.form</field>
        <field name="model">glucose.training.location</field>
        <field name="arch" type="xml">
            <form string="Training Location">
                <sheet>
                    <div class="oe_title">
                        <label for="name"/>
                        <h1>
                            <field name="name" placeholder="e.g., Mater Dei Hospital"/>
                        </h1>
                    </div>
                    <group>
                        <field name="active"/>
                    </group>
                    <notebook>
                        <page string="Patients" name="patients">
                            <field name="patient_ids">
                                <list>
                                    <field name="name"/>
                                    <field name="patient_internal_id"/>
                                </list>
                            </field>
                        </page>
                    </notebook>
                </sheet>
            </form>
        </field>
    </record>

    <!-- Training Location action -->
    <record id="action_training_locations" model="ir.actions.act_window">
        <field name="name">Training Locations</field>
        <field name="res_model">glucose.training.location</field>
        <field name="view_mode">list,form</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                Create a training location
            </p>
        </field>
    </record>

    <!-- Assignment Log list view -->
    <record id="view_assignment_log_tree" model="ir.ui.view">
        <field name="name">glucose.assignment.log.tree</field>
        <field name="model">glucose.assignment.log</field>
        <field name="arch" type="xml">
            <list string="Assignment Logs">
                <field name="installation_date"/>
                <field name="patient_id"/>
                <field name="patient_internal_id"/>
                <field name="equipment_id"/>
                <field name="equipment_serial"/>
                <field name="assignment_type" widget="badge"/>
                <field name="replacement_date"/>
            </list>
        </field>
    </record>

    <!-- Assignment Log form view -->
    <record id="view_assignment_log_form" model="ir.ui.view">
        <field name="name">glucose.assignment.log.form</field>
        <field name="model">glucose.assignment.log</field>
        <field name="arch" type="xml">
            <form string="Assignment Log">
                <sheet>
                    <group>
                        <group>
                            <field name="patient_id"/>
                            <field name="patient_internal_id"/>
                            <field name="equipment_id"/>
                            <field name="equipment_serial"/>
                        </group>
                        <group>
                            <field name="assignment_type"/>
                            <field name="installation_date"/>
                            <field name="replacement_date"/>
                        </group>
                    </group>
                </sheet>
            </form>
        </field>
    </record>

    <!-- Assignment Log action -->
    <record id="action_assignment_logs" model="ir.actions.act_window">
        <field name="name">Assignment History</field>
        <field name="res_model">glucose.assignment.log</field>
        <field name="view_mode">list,form</field>
    </record>

    <!-- Consumables Allocation list view -->
    <record id="view_consumables_allocation_tree" model="ir.ui.view">
        <field name="name">glucose.consumables.allocation.tree</field>
        <field name="model">glucose.consumables.allocation</field>
        <field name="arch" type="xml">
            <list string="Consumables Allocations">
                <field name="patient_internal_id"/>
                <field name="patient_id" string="Patient Name"/>
                <field name="month"/>
                <field name="year" options="{'enable_formatting': false}"/>
                <field name="quantity_allocated"/>
                <field name="quantity_used"/>
                <field name="threshold_status" widget="badge" 
                    decoration-success="threshold_status == 'green'" 
                    decoration-warning="threshold_status == 'orange'" 
                    decoration-danger="threshold_status == 'red'"/>
            </list>
        </field>
    </record>

    <!-- Consumables Allocation form view -->
    <record id="view_consumables_allocation_form" model="ir.ui.view">
        <field name="name">glucose.consumables.allocation.form</field>
        <field name="model">glucose.consumables.allocation</field>
        <field name="arch" type="xml">
            <form string="Consumables Allocation">
                <sheet>
                    <group>
                        <group>
                            <field name="patient_id"/>
                            <field name="patient_internal_id"/>
                        </group>
                        <group>
                            <field name="month"/>
                            <field name="year" options="{'enable_formatting': false}"/>
                        </group>
                    </group>
                    <group>
                        <group>
                            <field name="quantity_allocated"/>
                            <field name="quantity_used"/>
                        </group>
                        <group>
                            <field name="threshold"/>
                            <field name="threshold_status" widget="badge"/>
                        </group>
                    </group>
                </sheet>
            </form>
        </field>
    </record>

    <!-- Consumables Allocation action -->
    <record id="action_consumables_allocations" model="ir.actions.act_window">
        <field name="name">Consumables Allocations</field>
        <field name="res_model">glucose.consumables.allocation</field>
        <field name="view_mode">list,form</field>
    </record>

    <!-- Holiday Pump Request list view -->
    <record id="view_holiday_pump_request_tree" model="ir.ui.view">
        <field name="name">glucose.holiday.pump.request.tree</field>
        <field name="model">glucose.holiday.pump.request</field>
        <field name="arch" type="xml">
            <list string="Holiday Pump Requests">
                <field name="name"/>
                <field name="patient_name"/>
                <field name="main_pump_serial"/>
                <field name="contact_phone"/>
                <field name="travel_start_date"/>
                <field name="travel_end_date"/>
                <field name="destination"/>
                <field name="status" widget="badge" 
                    decoration-info="status == 'pending'" 
                    decoration-success="status == 'approved'" 
                    decoration-danger="status == 'rejected'"/>
            </list>
        </field>
    </record>

    <!-- Holiday Pump Request form view -->
    <record id="view_holiday_pump_request_form" model="ir.ui.view">
        <field name="name">glucose.holiday.pump.request.form</field>
        <field name="model">glucose.holiday.pump.request</field>
        <field name="arch" type="xml">
            <form string="Holiday Pump Request">
                <header>
                    <button name="action_approve" string="Approve &amp; Assign" type="object" class="oe_highlight" invisible="status != 'pending'"/>
                    <button name="action_reject" string="Reject" type="object" invisible="status != 'pending'"/>
                    <field name="status" widget="statusbar" statusbar_visible="pending,approved,rejected"/>
                </header>
                <sheet>
                    <div class="oe_title">
                        <label for="name"/>
                        <h1>
                            <field name="name"/>
                        </h1>
                    </div>
                    <group>
                        <group string="Patient Information">
                            <field name="patient_name"/>
                            <field name="main_pump_serial"/>
                            <field name="contact_phone"/>
                            <field name="contact_email"/>
                            <field name="patient_id"/>
                            <field name="patient_internal_id"/>
                        </group>
                        <group string="Travel Information">
                            <field name="travel_start_date"/>
                            <field name="travel_end_date"/>
                            <field name="destination"/>
                            <field name="submitted_date"/>
                        </group>
                    </group>
                    <group string="Holiday Pump Assignment">
                        <field name="holiday_pump_id" options="{'no_create': True}" invisible="status == 'rejected'"/>
                    </group>
                    <group>
                        <field name="reason"/>
                        <field name="additional_notes"/>
                    </group>
                </sheet>
                <chatter/>
            </form>
        </field>
    </record>

    <!-- Holiday Pump Request action -->
    <record id="action_holiday_pump_requests" model="ir.actions.act_window">
        <field name="name">Holiday Pump Requests</field>
        <field name="res_model">glucose.holiday.pump.request</field>
        <field name="view_mode">list,form</field>
    </record>

    <!-- Consumables menu directly under root -->
    <menuitem id="menu_consumables_allocations"
        name="Consumables"
        parent="menu_glucose_pumps_root"
        action="action_consumables_allocations"
        sequence="30"/>

    <!-- Submenus for operations -->
    <menuitem id="menu_operations"
        name="Operations"
        parent="menu_glucose_pumps_root"
        sequence="40"/>
    
    <menuitem id="menu_assignment_history"
        name="Assignment History"
        parent="menu_operations"
        action="action_assignment_logs"
        sequence="10"/>
    
    <menuitem id="menu_holiday_pump_requests"
        name="Holiday Pump Requests"
        parent="menu_operations"
        action="action_holiday_pump_requests"
        sequence="20"/>

    <menuitem id="menu_configuration"
        name="Configuration"
        parent="menu_glucose_pumps_root"
        sequence="100"/>
    
    <menuitem id="menu_training_locations"
        name="Training Locations"
        parent="menu_configuration"
        action="action_training_locations"
        sequence="10"/>

    <!-- Settings action -->
    <record id="action_glucose_pumps_settings" model="ir.actions.act_window">
        <field name="name">Settings</field>
        <field name="res_model">res.config.settings</field>
        <field name="view_mode">form</field>
        <field name="target">inline</field>
        <field name="context">{'module': 'insulin_pumps_evercare'}</field>
    </record>

    <!-- Glucose Pumps Settings form view -->
    <record id="view_glucose_pumps_settings_form" model="ir.ui.view">
        <field name="name">res.config.settings.view.form.glucose.pumps</field>
        <field name="model">res.config.settings</field>
        <field name="priority">999</field>
        <field name="inherit_id" ref="base.res_config_settings_view_form"/>
        <field name="arch" type="xml">
            <xpath expr="//form" position="inside">
                <app data-string="Insulin Pumps" string="Insulin Pumps" name="insulin_pumps_evercare" logo="/insulin_pumps_evercare/static/description/icon.png">
                    <block title="Device Configuration" name="device_config">
                        <setting id="glucose_pumps_products" string="Glucose Pump Products" help="Products marked as 'Glucose Pump Product' will be available for device assignment. Configure this on individual Product records.">
                            <div class="text-muted mt-2">
                                <i class="fa fa-info-circle"/> Go to Inventory &gt; Products to mark products as glucose pump products.
                            </div>
                        </setting>
                        <setting id="rma_product" string="RMA Replacement Products" help="Products marked as 'RMA Replacement Product' can only be used when replacing malfunctioning primary devices. Configure this on individual Product records.">
                            <div class="text-muted mt-2">
                                <i class="fa fa-info-circle"/> RMA devices can only be assigned through the Replace Device workflow.
                            </div>
                        </setting>
                        <setting id="return_location" string="Return Location" help="Location for returned devices.">
                            <div class="content-group mt-2">
                                <field name="glucose_pumps_return_location_id"/>
                            </div>
                        </setting>
                    </block>
                    <block title="Alerts Configuration" name="alerts_config">
                        <setting id="replacement_alert" string="Replacement Date Alerts" help="Days before replacement date to trigger an alert activity.">
                            <div class="content-group mt-2">
                                <div class="row">
                                    <label for="glucose_pumps_replacement_alert_days" class="col-lg-4"/>
                                    <field name="glucose_pumps_replacement_alert_days" class="oe_inline"/> days
                                </div>
                            </div>
                        </setting>
                    </block>
                    <block title="Consumables Configuration" name="consumables_config">
                        <setting id="consumables_threshold" string="Consumables Thresholds" help="Monthly thresholds for consumables allocation status.">
                            <div class="content-group mt-2">
                                <div class="row">
                                    <label for="glucose_pumps_default_allocated_quantity" class="col-lg-4"/>
                                    <field name="glucose_pumps_default_allocated_quantity" class="oe_inline"/> units (Allocated)
                                </div>
                                <div class="row">
                                    <label for="glucose_pumps_default_critical_threshold" class="col-lg-4"/>
                                    <field name="glucose_pumps_default_critical_threshold" class="oe_inline"/> units (Critical Threshold)
                                </div>
                            </div>
                        </setting>
                        <setting id="threshold_warnings" string="Enable Threshold Warnings" help="Show warnings when consumables usage approaches or exceeds threshold.">
                            <field name="glucose_pumps_enable_warnings"/>
                        </setting>
                    </block>
                    <block title="Helpdesk Configuration" name="helpdesk_config">
                        <setting id="helpdesk_email" string="Helpdesk Email" help="Email address for incoming and outgoing helpdesk communications.">
                            <div class="content-group mt-2">
                                <div class="row">
                                    <label for="glucose_pumps_helpdesk_email" class="col-lg-4"/>
                                    <field name="glucose_pumps_helpdesk_email" class="oe_inline"/>
                                </div>
                            </div>
                        </setting>
                    </block>
                </app>
            </xpath>
        </field>
    </record>

    <menuitem id="menu_glucose_pumps_settings"
        name="Settings"
        parent="menu_configuration"
        action="action_glucose_pumps_settings"
        sequence="99"/>
</odoo>
